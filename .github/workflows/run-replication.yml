# Run DGGS Benchmark Replication
#
# This workflow uses the pre-built Docker image to run the replication.
# The image is built by docker-build.yml and pushed to GitHub Container Registry.
#
# NOTE: GitHub Actions runners have limited memory (~7GB), so we use reduced
# dataset sizes by default. The full benchmark requires more resources.
#
# Triggered on:
# - Manual trigger (workflow_dispatch)
# - New release
# - Weekly schedule (for continuous verification)

name: Run Replication

on:
  workflow_dispatch:
    inputs:
      benchmark_type:
        description: 'Benchmark to run'
        required: true
        default: 'ci-test'
        type: choice
        options:
          - ci-test        # Reduced dataset for CI (default)
          - quick-test     # Minimal test
          - full           # Full benchmark (may OOM on GitHub Actions)
      random_seed:
        description: 'Random seed for reproducibility'
        required: false
        default: '42'
        type: string
      image_tag:
        description: 'Docker image tag to use'
        required: false
        default: 'latest'
        type: string

  release:
    types: [published]

  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  replication:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag
        id: image
        run: |
          TAG="${{ github.event.inputs.image_tag || 'latest' }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "full_name=${IMAGE}" >> $GITHUB_OUTPUT
          echo "Using image: ${IMAGE}"

      - name: Pull Docker image
        run: |
          docker pull ${{ steps.image.outputs.full_name }}

      - name: Show image info
        run: |
          echo "## Docker Image Info" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker inspect ${{ steps.image.outputs.full_name }} --format='Image: {{.RepoTags}}' >> $GITHUB_STEP_SUMMARY
          docker inspect ${{ steps.image.outputs.full_name }} --format='Created: {{.Created}}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration (from config.env in image)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker run --rm ${{ steps.image.outputs.full_name }} cat /app/config.env >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create results directory
        run: mkdir -p results

      - name: Determine benchmark parameters
        id: params
        run: |
          BENCHMARK_TYPE="${{ github.event.inputs.benchmark_type || 'ci-test' }}"
          echo "Benchmark type: $BENCHMARK_TYPE"
          
          case "$BENCHMARK_TYPE" in
            "quick-test")
              VECTOR_LAYERS="5,10,20"
              RASTER_LAYERS="5,10,20"
              POLYGONS_PER_LAYER="20"
              echo "### Benchmark Mode: Quick Test (minimal)" >> $GITHUB_STEP_SUMMARY
              ;;
            "ci-test")
              VECTOR_LAYERS="10,20,50,100"
              RASTER_LAYERS="10,50,100,500"
              POLYGONS_PER_LAYER="50"
              echo "### Benchmark Mode: CI Test (reduced dataset)" >> $GITHUB_STEP_SUMMARY
              ;;
            "full")
              VECTOR_LAYERS="10,20,50,100,200,500,1000"
              RASTER_LAYERS="10,50,100,500,1000,5000,10000"
              POLYGONS_PER_LAYER="100"
              echo "### Benchmark Mode: Full (paper values)" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ Requires >16GB RAM - may OOM on GitHub Actions" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          
          echo "vector_layers=${VECTOR_LAYERS}" >> $GITHUB_OUTPUT
          echo "raster_layers=${RASTER_LAYERS}" >> $GITHUB_OUTPUT
          echo "polygons_per_layer=${POLYGONS_PER_LAYER}" >> $GITHUB_OUTPUT
          echo "- Vector layers: ${VECTOR_LAYERS}" >> $GITHUB_STEP_SUMMARY
          echo "- Raster layers: ${RASTER_LAYERS}" >> $GITHUB_STEP_SUMMARY
          echo "- Polygons per layer: ${POLYGONS_PER_LAYER}" >> $GITHUB_STEP_SUMMARY

      - name: Run benchmark
        run: |
          echo "Running with:"
          echo "  VECTOR_LAYERS=${{ steps.params.outputs.vector_layers }}"
          echo "  RASTER_LAYERS=${{ steps.params.outputs.raster_layers }}"
          echo "  POLYGONS_PER_LAYER=${{ steps.params.outputs.polygons_per_layer }}"
          
          docker run --rm \
            -v ${{ github.workspace }}/results:/app/results \
            -e RANDOM_SEED=${{ github.event.inputs.random_seed || '42' }} \
            -e VECTOR_LAYERS=${{ steps.params.outputs.vector_layers }} \
            -e RASTER_LAYERS=${{ steps.params.outputs.raster_layers }} \
            -e POLYGONS_PER_LAYER=${{ steps.params.outputs.polygons_per_layer }} \
            ${{ steps.image.outputs.full_name }} \
            python run_replication.py --all --output results

      - name: Generate summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Replication Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results/comparison_with_paper.json ]; then
            echo "### Comparison with Paper Claims" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat results/comparison_with_paper.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f results/system_info.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### System Info" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat results/system_info.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la results/ 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No results directory"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: replication-results-${{ github.run_id }}
          path: results/
          retention-days: 90
          if-no-files-found: warn

      # Upload to release if triggered by release
      - name: Upload to release
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            results/*.csv
            results/*.json
            results/*.png
            results/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

