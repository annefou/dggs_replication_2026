# Run DGGS Benchmark Replication
#
# This workflow uses the pre-built Docker image to run the replication.
# The image is built by docker-build.yml and pushed to GitHub Container Registry.
#
# Triggered on:
# - Manual trigger (workflow_dispatch)
# - New release
# - Weekly schedule (for continuous verification)

name: Run Replication

on:
  workflow_dispatch:
    inputs:
      benchmark_type:
        description: 'Benchmark to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - vector
          - raster
          - quick-test
      random_seed:
        description: 'Random seed for reproducibility'
        required: false
        default: '42'
        type: string
      image_tag:
        description: 'Docker image tag to use'
        required: false
        default: 'latest'
        type: string

  release:
    types: [published]

  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  replication:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour timeout for full benchmark

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag
        id: image
        run: |
          TAG="${{ github.event.inputs.image_tag || 'latest' }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "full_name=${IMAGE}" >> $GITHUB_OUTPUT
          echo "Using image: ${IMAGE}"

      - name: Pull Docker image
        run: |
          docker pull ${{ steps.image.outputs.full_name }}

      - name: Show image info
        run: |
          echo "## Docker Image Info" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker inspect ${{ steps.image.outputs.full_name }} --format='Image: {{.RepoTags}}' >> $GITHUB_STEP_SUMMARY
          docker inspect ${{ steps.image.outputs.full_name }} --format='Created: {{.Created}}' >> $GITHUB_STEP_SUMMARY
          docker inspect ${{ steps.image.outputs.full_name }} --format='Size: {{.Size}}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration (from config.env in image)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker run --rm ${{ steps.image.outputs.full_name }} cat /app/config.env >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create results directory
        run: mkdir -p results

      - name: Run quick test
        if: ${{ github.event.inputs.benchmark_type == 'quick-test' }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/results:/app/results \
            -e RANDOM_SEED=${{ github.event.inputs.random_seed || '42' }} \
            ${{ steps.image.outputs.full_name }} \
            python -c "
          import run_replication
          run_replication.CONFIG['vector']['num_layers_list'] = [5, 10, 20]
          run_replication.CONFIG['raster']['num_layers_list'] = [5, 10, 20]
          run_replication.CONFIG['random_seed'] = ${{ github.event.inputs.random_seed || '42' }}
          import sys
          sys.argv = ['run_replication.py', '--all', '--output', 'results']
          run_replication.main()
          "

      - name: Run full replication
        if: ${{ github.event.inputs.benchmark_type == 'all' || github.event.inputs.benchmark_type == '' }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/results:/app/results \
            -e RANDOM_SEED=${{ github.event.inputs.random_seed || '42' }} \
            ${{ steps.image.outputs.full_name }} \
            python run_replication.py --all --output results --seed ${{ github.event.inputs.random_seed || '42' }}

      - name: Run vector benchmark only
        if: ${{ github.event.inputs.benchmark_type == 'vector' }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/results:/app/results \
            -e RANDOM_SEED=${{ github.event.inputs.random_seed || '42' }} \
            ${{ steps.image.outputs.full_name }} \
            python run_replication.py --generate-data --vector --compare --plot --output results --seed ${{ github.event.inputs.random_seed || '42' }}

      - name: Run raster benchmark only
        if: ${{ github.event.inputs.benchmark_type == 'raster' }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/results:/app/results \
            -e RANDOM_SEED=${{ github.event.inputs.random_seed || '42' }} \
            ${{ steps.image.outputs.full_name }} \
            python run_replication.py --generate-data --raster --compare --plot --output results --seed ${{ github.event.inputs.random_seed || '42' }}

      - name: Generate summary
        run: |
          echo "## Replication Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results/comparison_with_paper.json ]; then
            echo "### Comparison with Paper Claims" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat results/comparison_with_paper.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la results/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: replication-results-${{ github.run_id }}
          path: results/
          retention-days: 90

      - name: Upload plots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-plots-${{ github.run_id }}
          path: |
            results/*.png
            results/*.pdf
          retention-days: 90

      # Upload to release if triggered by release
      - name: Upload to release
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            results/*.csv
            results/*.json
            results/*.png
            results/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Verify replication success
  verify:
    needs: replication
    runs-on: ubuntu-latest
    steps:
      - name: Download results
        uses: actions/download-artifact@v4
        with:
          name: replication-results-${{ github.run_id }}
          path: results

      - name: Check replication status
        run: |
          if [ -f results/comparison_with_paper.json ]; then
            # Check if claims were replicated
            VECTOR_OK=$(python3 -c "import json; d=json.load(open('results/comparison_with_paper.json')); print('true' if d.get('vector_benchmark',{}).get('replicated') else 'false')")
            RASTER_OK=$(python3 -c "import json; d=json.load(open('results/comparison_with_paper.json')); print('true' if d.get('raster_benchmark',{}).get('replicated') else 'false')")
            
            echo "Vector benchmark replicated: $VECTOR_OK"
            echo "Raster benchmark replicated: $RASTER_OK"
            
            if [ "$VECTOR_OK" = "true" ] && [ "$RASTER_OK" = "true" ]; then
              echo "✅ Replication successful!" >> $GITHUB_STEP_SUMMARY
              exit 0
            else
              echo "⚠️ Replication shows different patterns than paper" >> $GITHUB_STEP_SUMMARY
              echo "This may be expected due to hardware differences."
              exit 0
            fi
          else
            echo "❌ No comparison results found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
